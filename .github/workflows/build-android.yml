name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      backend_url:
        description: '后端 API 地址（例如：https://your-api.example.com）'
        required: true
        default: 'https://your-api.example.com'
        type: string
  workflow_call:
    inputs:
      backend_url:
        description: '后端 API 地址'
        required: true
        type: string

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      # 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 设置 pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9.0.0'

      # 设置 Java 环境
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      # 缓存 pnpm 依赖
      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            client/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # 安装依赖
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile

      # 缓存 Expo
      - name: Cache Expo
        uses: actions/cache@v4
        with:
          path: |
            ~/.expo
            ~/.expo-shared
          key: ${{ runner.os }}-expo-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-expo-

      # 获取后端 URL
      - name: Get Backend URL
        id: backend-url
        run: |
          # 优先级 1：workflow_dispatch 输入参数
          if [ -n "${{ inputs.backend_url }}" ]; then
            echo "url=${{ inputs.backend_url }}" >> $GITHUB_OUTPUT
            echo "Using backend URL from workflow input"
          # 优先级 2：GitHub Secrets
          elif [ -n "${{ secrets.BACKEND_URL }}" ]; then
            echo "url=${{ secrets.BACKEND_URL }}" >> $GITHUB_OUTPUT
            echo "Using backend URL from Secrets"
          # 优先级 3：默认值（需要修改）
          else
            echo "url=https://your-api.example.com" >> $GITHUB_OUTPUT
            echo "⚠️  WARNING: Using default backend URL!"
            echo "   Please provide a valid backend URL via:"
            echo "   1. GitHub Secret: BACKEND_URL"
            echo "   2. Workflow input: backend_url"
            exit 1
          fi

      # 验证后端 URL
      - name: Validate Backend URL
        run: |
          BACKEND_URL="${{ steps.backend-url.outputs.url }}"
          echo "Backend URL: $BACKEND_URL"

          # 检查 URL 格式
          if ! echo "$BACKEND_URL" | grep -qE '^https?://'; then
            echo "❌ Error: Invalid URL format"
            echo "   URL must start with http:// or https://"
            exit 1
          fi

          # 检查是否为默认值
          if [ "$BACKEND_URL" = "https://your-api.example.com" ]; then
            echo "❌ Error: Using default placeholder URL"
            echo "   Please provide a real backend URL"
            exit 1
          fi

          echo "✅ Backend URL is valid"

      # 生成 Android 原生项目
      - name: Prebuild Android
        run: |
          cd client
          # 设置环境变量（在构建时内联到 APK）
          export EXPO_PUBLIC_BACKEND_BASE_URL="${{ steps.backend-url.outputs.url }}"
          echo "Building with backend URL: $EXPO_PUBLIC_BACKEND_BASE_URL"
          npx expo prebuild --platform android --clean

      # 构建 Debug APK
      - name: Build Debug APK
        run: |
          cd client/android
          ./gradlew assembleDebug --stacktrace

      # 构建 Release APK
      - name: Build Release APK
        run: |
          cd client/android
          ./gradlew assembleRelease --stacktrace

      # 上传 Debug APK
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-${{ github.run_number }}
          path: client/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      # 上传 Release APK
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ github.run_number }}
          path: client/android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

      # 显示构建信息
      - name: Build Summary
        run: |
          echo "==================================="
          echo "  APK Build Complete"
          echo "==================================="
          echo "Backend URL: ${{ steps.backend-url.outputs.url }}"
          echo "Build Number: ${{ github.run_number }}"
          echo ""
          echo "Download APKs from:"
          echo "  https://github.com/2Yong2r/GoalWall/actions/runs/${{ github.run_id }}"
